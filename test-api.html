<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouteSnap - æ™ºæ…§å–®æ“šè­˜åˆ¥ (å„ªåŒ–ç‰ˆ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f7;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #86868b;
            margin-bottom: 24px;
        }

        input[type="file"] {
            display: block;
            width: 100%;
            padding: 12px;
            border: 2px dashed #0071e3;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        button {
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            flex: 1;
        }

        button:hover {
            background: #0077ed;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.secondary {
            background: #e5e5ea;
            color: #1d1d1f;
        }

        button.secondary:hover {
            background: #d1d1d6;
        }

        .loading {
            display: none;
            color: #0071e3;
            margin: 16px 0;
            font-weight: 500;
        }

        .loading.active {
            display: block;
        }

        .result-item {
            background: #f5f5f7;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            border-left: 4px solid #0071e3;
        }

        .result-item.error {
            border-left-color: #ff3b30;
        }

        .result-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .json-box {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 8px;
        }

        .log {
            background: #1d1d1f;
            color: #00ff00;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 4px;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 1200px;
            max-height: 90vh;
            object-fit: contain;
            margin-top: 20px;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>ğŸš€ RouteSnap æ™ºæ…§å–®æ“šè­˜åˆ¥</h1>
        <p class="subtitle">æ”¯æ´å¤šåœ–ä¸Šå‚³ã€è‡ªå‹•å£“ç¸®ã€ä½‡åˆ—è™•ç†</p>

        <!-- Accept multiple files -->
        <input type="file" id="imageInput" accept="image/*" multiple>

        <div class="btn-group">
            <button id="processBtn" onclick="startProcessing()">é–‹å§‹è¾¨è­˜</button>
            <button class="secondary" onclick="clearLogs()">æ¸…é™¤ç´€éŒ„</button>
        </div>

        <div class="loading" id="loading">â³ æ­£åœ¨è™•ç†ä½‡åˆ—ä¸­... <span id="progressText"></span></div>

        <div id="resultsArea"></div>
        <div id="logs" class="log"></div>
    </div>

    <!-- The Modal -->
    <div id="myModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="img01">
    </div>

    <script>
        const API_URL = 'https://routesnap-backend.lalawgwg99.workers.dev';
        const fileInput = document.getElementById('imageInput');
        const processBtn = document.getElementById('processBtn');
        const loading = document.getElementById('loading');
        const progressText = document.getElementById('progressText');
        const resultsArea = document.getElementById('resultsArea');
        const logsDiv = document.getElementById('logs');

        let fileQueue = [];
        let isProcessing = false;

        // Logging function
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ“';
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.textContent = `[${timestamp}] ${emoji} ${message}`;
            logsDiv.prepend(div); // Newest on top
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
            resultsArea.innerHTML = '';
        }

        // Image Compression Function
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();

                reader.onload = (e) => {
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Calculate new size (Max 1024px width/height)
                        const MAX_SIZE = 1024;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // Draw and compress
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                addLog(`å£“ç¸®å®Œæˆ: ${(file.size / 1024).toFixed(0)}KB -> ${(blob.size / 1024).toFixed(0)}KB`, 'info');
                                // Force memory cleanup
                                img.src = '';
                                resolve(blob);
                            } else {
                                reject(new Error('Canvas toBlob failed'));
                            }
                        }, 'image/jpeg', 0.7); // 0.7 Quality
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.readAsDataURL(file);
            });
        }

        // Queue Processing Logic
        async function startProcessing() {
            if (fileInput.files.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å¼µåœ–ç‰‡ï¼');
                return;
            }

            // Add files to queue
            fileQueue = Array.from(fileInput.files);
            addLog(`å·²åŠ å…¥ ${fileQueue.length} å¼µåœ–ç‰‡åˆ°ä½‡åˆ—`);

            processBtn.disabled = true;
            loading.classList.add('active');

            await processQueue();

            processBtn.disabled = false;
            loading.classList.remove('active');
            addLog('ğŸ‰ æ‰€æœ‰åœ–ç‰‡è™•ç†å®Œæˆï¼', 'success');
        }

        async function processQueue() {
            const total = fileInput.files.length;

            while (fileQueue.length > 0) {
                const currentFile = fileQueue.shift(); // Take first
                const index = total - fileQueue.length;
                progressText.textContent = `(${index}/${total})`;

                addLog(`æ­£åœ¨è™•ç†ç¬¬ ${index} å¼µ: ${currentFile.name}...`);

                try {
                    // 1. Compress
                    const compressedBlob = await compressImage(currentFile);

                    // 2. Prepare Form Data with Custom Prompt
                    const formData = new FormData();
                    formData.append('image', compressedBlob);
                    // Injecting the custom prompt here to be picked up by backend
                    formData.append('prompt', `
                        ä½ æ˜¯ä¸€å€‹å°ç£ç‰©æµè·¯å¾‘è¦åŠƒå°ˆå®¶ã€‚è«‹åˆ†æé€™å¼µæ”¶æ“šæˆ–æ‰‹å¯«å–®åœ–ç‰‡ã€‚
                        
                        ã€é‡è¦æŒ‡å¼•ã€‘
                        è«‹ã€Œå¿½ç•¥ã€ï¼šæ¢ç¢¼ã€åƒ¹æ ¼ã€åº—å…§ä»£ç¢¼ã€å•†åº—åç¨±ã€‚
                        è«‹ã€Œå°ˆæ³¨æå–ã€ä»¥ä¸‹æ¬„ä½ï¼š
                        1. å®¢æˆ¶å (Customer Name)
                        2. é›»è©± (Telephone)
                        3. åœ°å€ (Address) - (å¾é…é€èµ·é»å‡ºç™¼)ï¼Œè«‹åšé †è·¯æ’åºã€‚è‹¥æ¨¡ç³Šè«‹ä¿®æ­£ç‚ºæ­£ç¢ºè¡Œæ”¿å€ã€‚
                        4. é…é€æ™‚é–“ (Delivery Time)
                        5. å–®å“åç¨± (Item Name)
                        6. è¨‚è²¨ç·¨è™Ÿ (Order Number)
                        7. ç™¼ç¥¨è™Ÿç¢¼ (Invoice Number)

                        è«‹ç›´æ¥å›å‚³ç´” JSON æ ¼å¼ï¼Œä¸è¦ Markdownã€‚
                        æ ¼å¼: { "orders": [ { "customer": "...", "phone": "...", "address": "...", "delivery_time": "...", "items": "...", "orderNumber": "...", "invoiceNumber": "...", "note": "..." } ] }
                    `);

                    // 3. Send to API
                    const response = await fetch(`${API_URL}/api/analyze`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const json = await response.json();

                    // 4. Render Result
                    if (json.success) {
                        renderResult(json.data, currentFile, index);
                        addLog(`âœ… ç¬¬ ${index} å¼µè¾¨è­˜æˆåŠŸ`, 'success');
                    } else {
                        throw new Error(json.error || 'Unknown error');
                    }

                } catch (error) {
                    addLog(`âŒ ç¬¬ ${index} å¼µå¤±æ•—: ${error.message}`, 'error');
                    renderError(error.message, currentFile, index);
                }

                // 5. Buffer Delay (1 second)
                if (fileQueue.length > 0) {
                    addLog('â³ å†·å» 1 ç§’...', 'info');
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
        }

        // View Original Logic
        function renderResult(data, originalFile, index) {
            const div = document.createElement('div');
            div.className = 'result-item';

            // Create a temporary URL for the original file for viewing
            const originalUrl = URL.createObjectURL(originalFile);

            div.innerHTML = `
                <div class="result-title">
                    <span>ğŸ“„ è¨‚å–® #${index}</span>
                    <button onclick="viewOriginal('${originalUrl}')" style="padding: 4px 12px; font-size: 14px; width: auto; background: #34c759;">
                        ğŸ” æŸ¥çœ‹åŸåœ–
                    </button>
                </div>
                <div class="json-box">${JSON.stringify(data, null, 2)}</div>
            `;

            resultsArea.prepend(div);
        }

        function renderError(msg, originalFile, index) {
            const div = document.createElement('div');
            div.className = 'result-item error';
            const originalUrl = URL.createObjectURL(originalFile);
            div.innerHTML = `
                <div class="result-title">
                    <span>âŒ è¨‚å–® #${index} (å¤±æ•—)</span>
                     <button onclick="viewOriginal('${originalUrl}')" style="padding: 4px 12px; font-size: 14px; width: auto; background: #ff3b30;">
                        ğŸ” æŸ¥çœ‹åŸåœ–
                    </button>
                </div>
                <div class="json-box">${msg}</div>
            `;
            resultsArea.prepend(div);
        }

        // Modal Functions
        function viewOriginal(url) {
            const modal = document.getElementById("myModal");
            const modalImg = document.getElementById("img01");
            modal.style.display = "block";
            modalImg.src = url;
        }

        function closeModal() {
            document.getElementById("myModal").style.display = "none";
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById("myModal");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>

</html>